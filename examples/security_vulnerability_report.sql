-- =============================================================================
-- SECURITY VULNERABILITY REPORT
-- =============================================================================
-- Purpose: Focus on security-related patches and vulnerabilities
-- Use Case: Security team reporting, vulnerability management, compliance audits
-- Includes: Critical and high-severity patches, security bulletins, CVSS scores

SELECT m2.col1               AS "Customer Name",
       r.NAME                AS "Computer Name",
       p.os_name             AS "Operating System",
       CASE
         WHEN p2.health_status = 3 THEN 'Highly Vulnerable'
         WHEN p2.health_status = 2 THEN 'Vulnerable'
         WHEN p2.health_status = 1 THEN 'Healthy'
         ELSE 'Health Not Available'
       END                   AS "Security Health",
       p3.bulletinid         AS "Security Bulletin",
       pd.description        AS "Vulnerability Description",
       CASE
         WHEN a.status_id = 202 THEN 'Missing - CRITICAL'
         ELSE 'Protected'
       END                   AS "Protection Status",
       p5.platform_name      AS "Platform",
       LONG_TO_DATE(resource.db_updated_time) AS "Last Scan Date"
FROM   resource R
       INNER JOIN managedcomputer M ON m.resource_id = r.resource_id
       INNER JOIN patchmgmtosinfo P ON p.resource_id = m.resource_id
       INNER JOIN affectedpatchstatus A ON a.resource_id = m.resource_id
       INNER JOIN patch P3 ON p3.patchid = a.patch_id
       INNER JOIN patchdetails Pd ON pd.patchid = a.patch_id
       INNER JOIN pmpatchtype P4 ON p4.patchid = pd.patchid
       INNER JOIN platform P5 ON p5.platform_id = p4.platform_id
       LEFT JOIN pmreshealthstatus P2 ON p2.resource_id = m.resource_id
       LEFT JOIN managedcomputercustomfields M2 ON m2.resource_id = m.resource_id
WHERE  m.managed_status = 61 
       AND (p3.bulletinid LIKE 'MS%' 
            OR pd.description LIKE '%Security%' 
            OR pd.description LIKE '%Critical%')
       AND a.status_id = 202  -- Only missing patches
ORDER BY CASE WHEN p2.health_status = 3 THEN 1 
              WHEN p2.health_status = 2 THEN 2 
              ELSE 3 END, 
         r.NAME;